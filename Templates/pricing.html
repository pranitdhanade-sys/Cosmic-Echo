<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium - Astrophysics Hub</title>
    <style>
        :root {
            --primary-color: #ffffff;
            --accent-color: #ffd860;
            --dark-bg: #000000;
            --semi-dark-bg: rgba(10, 10, 10, 0.7);
            --color-text-primary: #ffffff;
            --color-text-secondary: #ececec;
            --color-card-bg: rgba(10, 15, 25, 0.65);
            --color-border: rgba(255, 255, 255, 0.9);
            --transition-fast: 0.3s ease;
            --transition-med: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', Arial, sans-serif;
            background: var(--dark-bg);
            color: var(--color-text-primary);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Starfield Background */
        canvas#star-field {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            pointer-events: none;
        }

        /* Navigation Bar */
        nav.navbar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            min-height: 100px;
            display: flex;
            align-items: center;
            padding: 0 40px;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            gap: 40px;
        }

        .navbar-logo img {
            height: 80px;
            width: auto;
            transition: transform var(--transition-fast), filter var(--transition-fast);
        }

        .navbar-logo img:hover {
            transform: scale(1.08);
            filter: drop-shadow(0 0 8px var(--accent-color));
        }

        .navbar-menu {
            display: flex;
            gap: 20px;
        }

        .navbar-menu a {
            color: #ececec;
            text-decoration: none;
            font-weight: 600;
            font-size: 1.04rem;
            letter-spacing: 0.03em;
            padding: 8px 15px;
            transition: color var(--transition-fast);
            position: relative;
        }

        .navbar-menu a::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--accent-color);
            transform: scaleX(0);
            transform-origin: center;
            transition: transform var(--transition-fast);
        }

        .navbar-menu a:hover {
            color: var(--primary-color);
        }

        .navbar-menu a:hover::after {
            transform: scaleX(1);
        }

        .navbar-menu a.active {
            color: var(--accent-color);
        }

        .navbar-menu a.active::after {
            transform: scaleX(1);
        }

        .navbar-menu a.login-btn {
            background: var(--accent-color);
            color: var(--dark-bg);
            padding: 10px 24px;
            border-radius: 6px;
            font-weight: 700;
            margin-left: 10px;
        }

        .navbar-menu a.login-btn:hover {
            background: #ffed4e;
            color: var(--dark-bg);
        }

        .navbar-menu a.login-btn::after {
            display: none;
        }

        /* Main Content */
        main {
            position: relative;
            z-index: 2;
            padding-top: 100px;
            padding-bottom: 60px;
        }

        .pricing-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Hero Section */
        .hero-section {
            text-align: center;
            margin-bottom: 4rem;
            animation: fadeInUp 1s ease;
        }

        .hero-section h1 {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-weight: 900;
        }

        .hero-section p {
            font-size: 1.3rem;
            color: var(--color-text-secondary);
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.6;
        }

        /* Pricing Cards */
        .pricing-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 4rem;
        }

        .pricing-card {
            background: var(--color-card-bg);
            border-radius: 20px;
            padding: 2.5rem;
            border: 2px solid var(--color-border);
            position: relative;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
            animation: fadeInUp 1s ease;
        }

        .pricing-card:hover {
            transform: translateY(-10px);
            border-color: var(--color-accent);
            box-shadow: 0 20px 60px rgba(74, 158, 255, 0.3);
        }

        .pricing-card.premium {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, rgba(10, 15, 25, 0.9) 0%, rgba(20, 25, 35, 0.9) 100%);
        }

        .pricing-card.premium:hover {
            box-shadow: 0 20px 60px rgba(255, 216, 96, 0.3);
        }

        .badge {
            position: absolute;
            top: -15px;
            right: 20px;
            background: linear-gradient(135deg, var(--accent-color) 0%, #ffed4e 100%);
            color: var(--dark-bg);
            padding: 0.5rem 1.5rem;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            box-shadow: 0 5px 20px rgba(255, 216, 96, 0.3);
        }

        .plan-name {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--color-text-primary);
        }

        .premium .plan-name {
            color: var(--accent-color);
        }

        .plan-description {
            color: var(--color-text-secondary);
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .price {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .premium .price {
            color: var(--accent-color);
        }

        .price-period {
            color: var(--color-text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }

        .features-list {
            list-style: none;
            margin-bottom: 2rem;
        }

        .features-list li {
            padding: 0.8rem 0;
            border-bottom: 1px solid rgba(74, 158, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--color-text-secondary);
        }

        .features-list li:last-child {
            border-bottom: none;
        }

        .check-icon {
            color: #4ade80;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .cross-icon {
            color: #f87171;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .cta-button {
            width: 100%;
            padding: 1.2rem;
            border: 2px solid var(--primary-color);
            border-radius: 7px;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            cursor: pointer;
            transition: all var(--transition-fast);
            background: transparent;
            color: var(--primary-color);
        }

        .cta-button:hover {
            transform: scale(1.05);
            background: var(--accent-color);
            color: var(--dark-bg);
            border-color: var(--accent-color);
        }

        .premium .cta-button {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: var(--dark-bg);
        }

        .premium .cta-button:hover {
            background: #ffed4e;
            border-color: #ffed4e;
        }

        /* Feature Comparison Table */
        .comparison-section {
            margin-top: 4rem;
            animation: fadeInUp 1s ease 0.3s both;
        }

        .comparison-section h2 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 3rem;
            color: var(--accent-color);
            font-weight: 700;
        }

        .comparison-table {
            background: var(--color-card-bg);
            border-radius: 20px;
            padding: 2rem;
            border: 2px solid var(--color-border);
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 1.5rem;
            text-align: left;
            border-bottom: 1px solid rgba(74, 158, 255, 0.1);
        }

        th {
            font-size: 1.3rem;
            color: var(--accent-color);
            font-weight: 700;
        }

        td {
            color: var(--color-text-secondary);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* FAQ Section */
        .faq-section {
            margin-top: 4rem;
            animation: fadeInUp 1s ease 0.4s both;
        }

        .faq-section h2 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 3rem;
            color: var(--accent-color);
            font-weight: 700;
        }

        .faq-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .faq-item {
            background: var(--color-card-bg);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 2px solid var(--color-border);
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .faq-item:hover {
            border-color: var(--accent-color);
        }

        .faq-question {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-text-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .faq-answer {
            margin-top: 1rem;
            color: var(--color-text-secondary);
            line-height: 1.6;
            display: none;
        }

        .faq-item.active .faq-answer {
            display: block;
        }

        .faq-toggle {
            font-size: 1.5rem;
            color: var(--accent-color);
            transition: transform 0.3s ease;
        }

        .faq-item.active .faq-toggle {
            transform: rotate(45deg);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-section h1 {
                font-size: 2.5rem;
            }

            .hero-section p {
                font-size: 1.1rem;
            }

            .pricing-cards {
                grid-template-columns: 1fr;
            }

            .nav-links {
                gap: 1rem;
                font-size: 0.9rem;
            }

            nav {
                padding: 1rem;
            }

            .logo {
                font-size: 1.4rem;
            }

            th, td {
                padding: 1rem;
                font-size: 0.9rem;
            }
        }

        @media (max-width: 480px) {
            .pricing-container {
                padding: 1rem;
            }

            .pricing-card {
                padding: 1.5rem;
            }

            .price {
                font-size: 2.5rem;
            }

            .nav-links {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
        /* Widget CSS */
    #astro-fab {
        position: fixed; bottom: 30px; right: 30px; width: 120px; height: 120px;
        background: #ffd860; color: #000; border: none; border-radius: 50%;
        font-size: 40px; cursor: pointer; box-shadow: 0 0 20px rgba(255, 216, 96, 0.4);
        z-index: 9999; transition: transform 0.3s;
    }
    #astro-fab:hover { transform: scale(1.1); }

    #astro-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 10000;
        display: none; align-items: center; justify-content: center;
    }
    .astro-panel {
        background: rgba(20, 20, 30, 0.95); border: 2px solid #ffd860; padding: 80px;
        border-radius: 20px; text-align: center; position: relative; width: 600px;
        box-shadow: 0 0 50px rgba(255, 216, 96, 0.2);
    }
    .astro-panel h2 { color: #fff; margin-bottom: 5px; font-family: sans-serif; }
    .astro-panel p { color: #ccc; margin-bottom: 30px; font-family: sans-serif; }
    
    .widget-mic {
        width: 100px; height: 100px; margin: 0 auto; background: rgba(255,216,96,0.1);
        border-radius: 50%; display: flex; align-items: center; justify-content: center;
        border: 2px solid #ffd860; cursor: pointer; position: relative; font-size: 2rem; color: #ffd860;
    }
    .widget-mic.listening { box-shadow: 0 0 40px #ffd860; background: #ffd860; color: #000; }
    
    .w-vision-btn {
        width: 100%; padding: 12px; margin-top: 20px; background: transparent;
        border: 1px solid #ffd860; color: #ffd860; border-radius: 8px; cursor: pointer;
        font-weight: 700; transition: 0.3s;
    }
    .w-vision-btn.active { background: #ffd860; color: #000; }
    
    .w-hud { margin-top: 20px; display: flex; justify-content: space-between; font-size: 0.9rem; color: #fff; }
    .close-widget { position: absolute; top: 15px; right: 15px; background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; }
    
    #w-camera-preview {
        position: absolute; top: 20px; right: 20px; width: 120px; border-radius: 10px;
        border: 2px solid #ffd860; display: none; transform: scaleX(-1);
    }



    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <a href="homepage.html" class="navbar-logo"><img src="mylogo.png" alt="StellerAtlas Logo" style="height: 80px;"></a>
        <div class="navbar-menu">
            <a href="homepage.html">HOME</a>
            <a href="blogpage.html">BLOGS</a>
            <a href="astronomy.html">ASTRONOMY</a>
            <a href="resources.html">RESOURCES</a>
            <a href="community.html">COMMUNITY</a>
            <a href="missions.html">MISSIONS</a>
            <a href="premium.html" class="active">PRICING</a>
            <a href="login.html" class="login-btn">LOGIN</a>
        </div>
    </nav>
 <div id="astro-widget-container">
    <button id="astro-fab" onclick="window.AstroWidget.toggle()">
        <i class="fa-solid fa-eye"></i>
    </button>

    <div id="astro-overlay">
        <div class="astro-panel">
            <button class="close-widget" onclick="window.AstroWidget.toggle()">&times;</button>
            <h2>ASTRO-BRIEF AI</h2>
            <p>Your Co-Pilot is Ready.</p>
            
            <div class="widget-mic" onmousedown="window.AstroWidget.startListening()" onmouseup="window.AstroWidget.stopListening()">
                <div class="w-mic-ring"></div>
                <i class="fa-solid fa-microphone"></i>
            </div>
            <p style="font-size:0.8rem; color:#888; margin-top:10px;">Hold Spacebar or Click</p>

            <button class="w-vision-btn" id="w-vision-btn" onclick="window.AstroWidget.toggleCamera()">
                <i class="fa-solid fa-camera"></i> Vision
            </button>

            <div class="w-hud">
                <span id="w-status">Ready</span>
                <span id="w-latency" style="color:#0f0; font-family:monospace;">0.0s</span>
            </div>
        </div>
        <video id="w-camera-preview" autoplay playsinline></video>
        <canvas id="w-snapshot-canvas" style="display:none;"></canvas>
    </div>
</div>
    <!-- Starfield Canvas -->
    <canvas id="star-field"></canvas>

    <!-- Main Content -->
    <main>
        <div class="pricing-container">
            <!-- Hero Section -->
            <section class="hero-section">
                <h1>Unlock the Universe</h1>
                <p>Choose the plan that fits your cosmic journey. Access premium features, exclusive content, and stay ahead with the latest space discoveries.</p>
            </section>

            <!-- Pricing Cards -->
            <div class="pricing-cards">
                <!-- Free Plan -->
                <div class="pricing-card">
                    <h3 class="plan-name">Free Explorer</h3>
                    <p class="plan-description">Perfect for casual space enthusiasts starting their journey</p>
                    <div class="price">$0</div>
                    <p class="price-period">Forever Free</p>
                    <ul class="features-list">
                        <li><span class="check-icon">‚úì</span> <strong>Standard AI Voice Assistant</strong></li>
                        <li><span class="check-icon">‚úì</span> Basic Image Captioning (Static Uploads)</li>
                        <li><span class="check-icon">‚úì</span> Text-to-Speech (Standard Voices)</li>
                        <li><span class="check-icon">‚úì</span> Access to Public Mission Logs</li>
                        <li><span class="cross-icon">‚úó</span> <strong>Murf Falcon "Emotive" Persona</strong></li>
                        <li><span class="cross-icon">‚úó</span> <strong>Audio Haptics (Data Sonification)</strong></li>
                        <li><span class="cross-icon">‚úó</span> <strong>Live Auto-Image Mode (Webcam)</strong></li>
                        <li><span class="cross-icon">‚úó</span> Deep Reasoning & Follow-up Q&A</li>
                        <li><span class="cross-icon">‚úó</span> Zero-Latency Priority Processing</li>
                    </ul>
                    <button class="cta-button" onclick="selectPlan('free')">Current Plan</button>
                </div>

                <!-- Premium Plan -->
                <div class="pricing-card premium">
                    <div class="badge">‚≠ê MOST POPULAR</div>
                    <h3 class="plan-name">Premium Astronaut</h3>
                    <p class="plan-description">For serious space enthusiasts who want unlimited access</p>
                    <div class="price">$4.99</div>
                    <p class="price-period">per month</p>
                    <ul class="features-list">
                        <li><span class="check-icon">‚úì</span> <strong>Murf Falcon Voice (Lecturer & Alert Personas)</strong></li>
                        <li><span class="check-icon">‚úì</span> <strong>Audio Haptics (Hear the Graphs)</strong></li>
                        <li><span class="check-icon">‚úì</span> <strong>Live Auto-Image Interpretation</strong></li>
                        <li><span class="check-icon">‚úì</span> <strong>Deep Reasoning (GPT-4o Vision)</strong></li>
                        <li><span class="check-icon">‚úì</span> <strong>Real-time Conversational Interruptions</strong></li>
                        <li><span class="check-icon">‚úì</span> <strong>Ultra-Low Latency Processing</strong></li>
                        <li><span class="check-icon">‚úì</span> Unlimited Visual Interpretations</li>
                        <li><span class="check-icon">‚úì</span> Priority Support for Educators</li>
                        <li><span class="check-icon">‚úì</span> <strong>Ad-free experience</strong></li>
                    </ul>
                    <button class="cta-button" onclick="selectPlan('premium')">Upgrade to Premium</button>
                </div>
            </div>

            

            <!-- FAQ Section -->
            <section class="faq-section">
                <h2>Frequently Asked Questions</h2>
                <div class="faq-container">
                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-question">
                            What's included in the Premium plan?
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            Premium membership gives you unlimited access to Unlimited Visual Interpretations, ad-free experience,Deep Reasoning (GPT-4o Vision), Live Auto-Image Interpretation and many more.
                        </div>
                    </div>


                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-question">
                            Can I cancel my subscription anytime?
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            Yes! You can cancel your Premium subscription at any time with no questions asked. Your Premium features will remain active until the end of your current billing period. No cancellation fees, no hassle.
                        </div>
                    </div>

                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-question">
                            Do you offer student discounts?
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            Yes! We offer a 50% discount for students. Simply email us at support@astrophysicshub.com with your valid student ID to receive your discount code. We're passionate about making space education accessible to everyone.
                        </div>
                    </div>

                    <div class="faq-item" onclick="toggleFaq(this)">
                        <div class="faq-question">
                            What payment methods do you accept?
                            <span class="faq-toggle">+</span>
                        </div>
                        <div class="faq-answer">
                            We accept all major credit cards (Visa, Mastercard, American Express), PayPal, and digital wallets including Apple Pay and Google Pay. All transactions are secured with industry-standard encryption.
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // FAQ Toggle Function
        function toggleFaq(element) {
            const isActive = element.classList.contains('active');
            
            // Close all FAQ items
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Open clicked item if it wasn't active
            if (!isActive) {
                element.classList.add('active');
            }
        }

        // Plan Selection Function
        function selectPlan(plan) {
            if (plan === 'free') {
                alert('You are currently on the Free Explorer plan. Enjoy exploring the cosmos!');
            } else if (plan === 'premium') {
                // In a real implementation, this would redirect to a payment gateway
                alert('Redirecting to secure checkout...\n\nYou\'re about to unlock unlimited access to the universe! üöÄ');
                // Simulate redirect
                // window.location.href = 'checkout.html?plan=premium';
            }
        }

        // Starfield canvas background animation
        const canvas = document.getElementById('star-field');
        const ctx = canvas.getContext('2d');
        let width, height;
        let stars = [];

        function initCanvas() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            stars = [];
            for(let i = 0; i < 150; i++) {
                stars.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    radius: Math.random() * 1.5 + 0.5,
                    alpha: Math.random(),
                    decreasing: Math.random() > 0.5,
                    vx: (Math.random() - 0.5) * 0.1,
                    vy: (Math.random() - 0.5) * 0.1
                });
            }
        }

        function drawStars() {
            ctx.clearRect(0, 0, width, height);
            stars.forEach(star => {
                if(star.decreasing) {
                    star.alpha -= 0.007;
                    if(star.alpha <= 0.1) star.decreasing = false;
                } else {
                    star.alpha += 0.007;
                    if(star.alpha >= 1) star.decreasing = true;
                }
                star.x += star.vx;
                star.y += star.vy;
                if (star.x < 0 || star.x > width) star.vx = -star.vx;
                if (star.y < 0 || star.y > height) star.vy = -star.vy;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, 2 * Math.PI);
                ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                ctx.fill();
            });
        }

        window.addEventListener('resize', initCanvas);
        function animateStars() {
            drawStars();
            requestAnimationFrame(animateStars);
        }
        initCanvas();
        animateStars();

        // Smooth scroll for navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Add scroll effect to cards
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -100px 0px'
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.style.opacity = '1';
                    entry.target.style.transform = 'translateY(0)';
                }
            });
        }, observerOptions);

        document.querySelectorAll('.pricing-card, .faq-item').forEach(el => {
            el.style.opacity = '0';
            el.style.transform = 'translateY(30px)';
            el.style.transition = 'all 0.6s ease';
            observer.observe(el);
        });

        window.AstroWidget = (function() {
        let w_mediaRecorder = null;
        let w_chunks = [];
        let w_cameraOn = false;
        let w_ctx = null; 
        let w_isOpen = false; // Track if widget is open

        function initAudio() {
            if (!w_ctx) w_ctx = new (window.AudioContext || window.webkitAudioContext)();
            if (w_ctx.state === 'suspended') w_ctx.resume();
        }

        function toggle() {
            const overlay = document.getElementById('astro-overlay');
            w_isOpen = (overlay.style.display === 'flex');
            
            if (w_isOpen) {
                overlay.style.display = 'none';
                w_isOpen = false;
            } else {
                overlay.style.display = 'flex';
                w_isOpen = true;
                initAudio();
            }
        }

        // --- SPACEBAR LISTENER FOR WIDGET ---
        document.addEventListener('keydown', (e) => {
            // Only activate if widget is OPEN and space is pressed
            if (w_isOpen && e.code === 'Space' && !e.repeat) {
                startListening();
            }
        });

        document.addEventListener('keyup', (e) => {
            if (w_isOpen && e.code === 'Space') {
                stopListening();
            }
        });
        // -------------------------------------

        async function toggleCamera() {
            const video = document.getElementById('w-camera-preview');
            const btn = document.getElementById('w-vision-btn');
            if (!w_cameraOn) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({video: true});
                    video.srcObject = stream; video.style.display = 'block';
                    w_cameraOn = true; btn.classList.add('active');
                } catch(e) { alert("Camera Permission Denied"); }
            } else {
                if(video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
                video.style.display = 'none'; w_cameraOn = false; btn.classList.remove('active');
            }
        }

        async function startListening() {
            initAudio();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                w_mediaRecorder = new MediaRecorder(stream);
                w_chunks = [];
                w_mediaRecorder.ondataavailable = e => w_chunks.push(e.data);
                w_mediaRecorder.onstop = sendData;
                w_mediaRecorder.start();
                
                document.querySelector('.widget-mic').classList.add('listening');
                document.getElementById('w-status').innerText = "Listening...";
                playTone(400);
            } catch(e) { 
                alert("Microphone Needed."); 
            }
        }

        function stopListening() {
            if(w_mediaRecorder && w_mediaRecorder.state !== 'inactive') w_mediaRecorder.stop();
            document.querySelector('.widget-mic').classList.remove('listening');
            document.getElementById('w-status').innerText = "Thinking...";
            playTone(300);
        }

        async function sendData() {
            const blob = new Blob(w_chunks, {type: 'audio/wav'});
            const formData = new FormData();
            formData.append("audio_data", blob, "voice.wav");

            if(w_cameraOn) {
                const vid = document.getElementById('w-camera-preview');
                const can = document.getElementById('w-snapshot-canvas');
                can.width = vid.videoWidth; can.height = vid.videoHeight;
                can.getContext('2d').drawImage(vid, 0, 0);
                const imgBlob = await new Promise(r => can.toBlob(r, 'image/jpeg'));
                formData.append("image_data", imgBlob, "frame.jpg");
            }

            let start = Date.now();
            fetch('/process_audio', {method: 'POST', body: formData})
            .then(r => r.json())
            .then(d => {
                let lat = (Date.now() - start)/1000;
                document.getElementById('w-latency').innerText = lat.toFixed(2) + 's';
                document.getElementById('w-status').innerText = "Speaking...";
                
                if(d.sonification_data?.length > 0) {
                    playMusic(d.sonification_data, () => { if(d.audio_base64) playAudio(d.audio_base64); });
                } else if(d.audio_base64) {
                    playAudio(d.audio_base64);
                }
            })
            .catch(e => { console.error(e); document.getElementById('w-status').innerText = "Offline?"; });
        }

        function playTone(f) {
            if(!w_ctx) return;
            const o = w_ctx.createOscillator(); const g = w_ctx.createGain();
            o.type='sine'; o.frequency.value=f; o.connect(g); g.connect(w_ctx.destination);
            o.start(); g.gain.exponentialRampToValueAtTime(0.001, w_ctx.currentTime+0.1); o.stop(w_ctx.currentTime+0.1);
        }
        function playMusic(d, cb) {
            let i=0; let iv = setInterval(() => {
                if(i>=d.length) { clearInterval(iv); cb(); return; }
                const o = w_ctx.createOscillator(); const g = w_ctx.createGain();
                o.type='triangle'; o.frequency.value=200+(d[i]*6); o.connect(g); g.connect(w_ctx.destination);
                o.start(); g.gain.exponentialRampToValueAtTime(0.001, w_ctx.currentTime+0.15); o.stop(w_ctx.currentTime+0.15);
                i++;
            }, 120);
        }
        function playAudio(b64) {
            new Audio("data:audio/mp3;base64,"+b64).play();
        }

        return { toggle, toggleCamera, startListening, stopListening };
    })();
    </script>
</body>
</html>
